# Neural Style Transfer using Pytorch
Artistic Style Transfer using CNN has shown appealing results with new forms of image manipulation. The prior optimization-based approaches are approximated by learning a feed-forward generative network and such models have shown real-time performance. Most of the existing models are capable of applying single style at a time. However, separate networks are required to train different style targets. In order to extend the scalability of this innovative algorithm, we train multiple instances of the same style and we experiment with Gram matrices to control the amount of style texture. </br>
![](https://github.com/AnushaManila/Master-Thesis/blob/master/05_Thesis_Slides/Slide04.jpg)

Beginning with the random noise, the idea is to update pixels in the stylized image (yet unknown) iteratively through backpropagation. The objective of image iteration is to minimize the total loss such that the stylized image simultaneously emulates the semantic essence of the content image and the style representation of the style image.

![](https://github.com/AnushaManila/Master-Thesis/blob/master/05_Thesis_Slides/Slide05.jpg)
## Getting Started

The basic idea of Style Transfer is from ['Image Style Transfer using CNN'](https://www.cv-foundation.org/openaccess/content_cvpr_2016/html/Gatys_Image_Style_Transfer_CVPR_2016_paper.html)


### Investigations on Gram matrices

The investigations are classified into four categories:

```
1. Eigen decomposition 
2. Descriptive statistics 
3. Style loss modification to reduce dimension
4. Style image patches
```
![](https://github.com/AnushaManila/Master-Thesis/blob/master/05_Thesis_Slides/Slide10.jpg)</br>
A Gram (or Grammian) matrix G in the context of style transfer contains the un-shifted cross-correlation between all pairs of feature maps within the same layers of the CNN. The feature map contains a high-level presentation of features such as colors, texture, edges, and shapes. A cross-correlation of feature maps on an image with respect to itself gives a measure of which features in an image occur together, and these correlated features constitute the style of an image intuitively. The essence of neural style transfer is to match the feature distributions between the style images and the generated stylized images. G is a square (Nâ‡¥N) matrix with linearly independent eigenvectors p_i(i=1,....,N). The columns of P are the eigenvectors and lambda is the diagonal matrix whose diagonal elements are the corresponding eigenvalues. With Gatys et al as the baseline and using all the eigenvalues and eigenvectors of Gram matrices for the reconstruction, the recreation in above sub-figure is exactly same as the stylized image obtained by using original Gram matrices directly without eigen decomposition.

![](https://github.com/AnushaManila/Master-Thesis/blob/master/05_Thesis_Slides/Slide11.jpg) </br>
Reducing the weight of the corresponding eigenvector of 50% of the smallest eigenvalues preserves the style texture as shown above. Reducing the weight of the corresponding eigenvector of 90% of the smallest eigenvalues also preserves the style texture. The style texture differences among the two stylized images (one generated by using all the eigenvalues and another by employing the largest 10% of eigenvalues) are minute and noticeable only in their original resolution. The contributions of remaining eigenvalues are negligible.

![](https://github.com/AnushaManila/Master-Thesis/blob/master/05_Thesis_Slides/Slide12.jpg) </br>
Similarly, the eigenvector corresponding to the smallest eigenvalue is replaced with a normalized vector of ones as in equation above and the smallest eigenvalue to be million times smaller than the actual value. This approach preserves the texture information with scattered noise as in sub-figure above and the stylized image appears slightly different from the resulting image of previous reconstructions.

![](https://github.com/AnushaManila/Master-Thesis/blob/master/05_Thesis_Slides/Slide13.jpg)</br>
Eigenvalue index vs eigenvalue magnitude plotted for a specific Gram matrix with dimension 512X512. Only the largest 5% (0 to 25) eigenvalues are significant as shown in the plot. The remaining 90% to 95% have comparatively lower eigenvalue magnitudes and their contribution is negligible in neural style transfer.

![](https://github.com/AnushaManila/Master-Thesis/blob/master/05_Thesis_Slides/Slide18.jpg)</br>
The maximum and minimum provide good examples of the types of descriptive statistics which are easy to marginalize; while, mean is one of the measures of central tendency in a given dataset. To be able to feed multiple instances of the same style at a time, the element-wise mean is computed, maximum and minimum of the Gram matrices of each instance and reconstructed as single Gram matrix for each style-layer. The generated stylized images are shown in figure above.

![](https://github.com/AnushaManila/Master-Thesis/blob/master/05_Thesis_Slides/Slide14.jpg)</br>
In order to check the possibility of reducing the dimensionality of style texture, I reformed the style loss function as in equation above. The Gram matrices of the style layers are projected onto eigenspaces and the style loss is modified as detailed above. where G is the Gram matrix of style image and the column of P are eigenvectors of G.

![](https://github.com/AnushaManila/Master-Thesis/blob/master/05_Thesis_Slides/Slide15.jpg)</br>
![](https://github.com/AnushaManila/Master-Thesis/blob/master/05_Thesis_Slides/Slide16.jpg)</br>
Style transfer with modified style loss function. Comparison of results obtained by choosing sorted eigen components 10 percent sequentially.</br>
![](https://github.com/AnushaManila/Master-Thesis/blob/master/05_Thesis_Slides/Slide17.jpg)</br>
                  [AdaIN](https://arxiv.org/abs/1703.06868)
![](https://github.com/AnushaManila/Master-Thesis/blob/master/05_Thesis_Slides/Slide20.jpg)</br>
![](https://github.com/AnushaManila/Master-Thesis/blob/master/05_Thesis_Slides/Slide21.jpg)</br>

### Acknowledgment

* https://github.com/leongatys/PytorchNeuralStyleTransfer

